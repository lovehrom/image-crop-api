# ТЗ: Image Crop API
Дата: 2026-02-21
Статус: В работе

---

## Цель проекта

Разработать REST API для обрезки изображений с поддержкой поворота и скругления углов. API должен быть быстрым, масштабируемым и развернут на Vercel serverless.

---

## Функциональные требования

### Обязательные фичи (MVP - Phase 1)

1. **Basic Crop** — обрезка изображения по размерам и координатам
   - Параметры: width, height, x, y, cropWidth, cropHeight
   - Операции: обрезка с сохранением пропорций или без

2. **Resize** — изменение размера изображения
   - Параметры: width, height
   - Автоматическое вычисление высоты/ширины если указан только один параметр

3. **Rotate** — поворот изображения
   - Параметры: angle
   - Варианты: 90°, 180°, 270°, custom angle (0-360°)

4. **Border Radius** — скругление углов
   - Параметры: radius (10-50px)
   - Варианты: все 4 угла, только один

5. **Health Check** — проверка работоспособности
   - GET /health endpoint
   - Возвращает статус и версию API

### Опциональные фичи (Phase 2)

1. **Batch Operations** — несколько операций за 1 запрос
   - Массив операций: [{type, params}]
   - Типы: crop, resize, rotate, border-radius

2. **Formats** — разные форматы вывода
   - Параметр: format
   - Варианты: png, jpeg, webp

3. **Auto-focal** — автоматическое определение центра изображения
   - Автоматический расчёт центра обрезки

---

## Технические требования

### Backend Stack

- **Runtime:** Node.js ^18.0.0
- **Framework:** Express.js
- **Image Processing:** Sharp (^0.33.0)
- **Deployment:** Vercel Serverless

### API Структура

```
project/
├── src/
│   ├── routes/
│   │   └── index.js       # Основной маршрутизатор
│   ├── controllers/
│   │   ├── crop.js      # Логика обрезки
│   │   ├── resize.js    # Логика ресайза
│   │   ├── rotate.js     # Логика поворота
│   │   └── health.js     # Health check
│   ├── services/
│   │   └── imageService.js # Обработка изображений (Sharp)
│   ├── middleware/
│   │   ├── validate.js   # Валидация параметров
│   │   └── errorHandler.js # Обработка ошибок
│   ├── utils/
│   │   ├── fileUtils.js   # Утилиты для файлов
│   │   └── constants.js   # Константы
│   └── index.js          # Точка входа
├── .env.example
├── package.json
├── vercel.json
├── README.md
└── .gitignore
```

### Endpoints

#### POST /crop
**Описание:** Обрезка изображения с опциональными операциями

**Параметры (multipart/form-data):**
- **file** (required, DATA) — Изображение для обработки (PNG/JPG, max 5MB)
- **width** (optional, NUMBER) — Новая ширина
- **height** (optional, NUMBER) — Новая высота
- **x** (optional, NUMBER) — X координата верхнего левого угла
- **y** (optional, NUMBER) — Y координата верхнего левого угла
- **cropWidth** (optional, NUMBER) — Ширина области обрезки
- **cropHeight** (optional, NUMBER) — Высота области обрезки
- **angle** (optional, NUMBER) — Угол поворота (0-360, 90, 180, 270)
- **radius** (optional, NUMBER) — Радиус скругления углов (10-50)
- **format** (optional, STRING) — Формат вывода (png, jpeg, webp, default: png)

**Ответ:**
- Status: 200 OK
- Content-Type: image/png (или указанный format)
- Body: Бинарное изображение

**Ошибки:**
- 400 Bad Request — неверные параметры
- 413 Payload Too Large — файл превышает 5MB

#### GET /health
**Описание:** Проверка работоспособности API

**Ответ:**
```json
{
  "status": "healthy",
  "version": "1.0.0",
  "timestamp": "2024-01-01T00:00:00Z"
}
```

---

## Валидация и безопасность

### Входные параметры
- **file:** Обязателен, формат: PNG/JPG, размер: max 5MB
- **width, height:** Минимум: 1px, Максимум: 10000px
- **x, y:** Минимум: 0, Максимум: ширина/высота изображения
- **cropWidth, cropHeight:** Минимум: 1px, Максимум: ширина/высота изображения
- **angle:** Минимум: 0, Максимум: 360, специальные значения: 90, 180, 270
- **radius:** Минимум: 10, Максимум: 50
- **format:** enum: png, jpeg, webp

### Ошибки
- Неверный формат файла
- Файл слишком большой (> 5MB)
- Неверные числовые параметры
- Неверные значения перечислений
- Невозможно обработать изображение

### Rate Limiting
- Vercel встроенный rate limiting
- Ограничение запросов: 100 req/мин (настраивается)

---

## Производительность

### Требования
- Время ответа: < 500ms для простых операций
- Время ответа: < 1s для сложных операций
- Размер выходного файла: оптимизировать для web

### Оптимизация
- Использовать кэширование Vercel
- Оптимизировать операции Sharp
- Использовать streaming для больших файлов

---

## Критерии приёмки

### Функциональные требования
- ✅ Все обязательные endpoints работают
- ✅ Basic crop работает
- ✅ Resize работает
- ✅ Rotate работает (90°, 180°, 270°, custom)
- ✅ Border radius работает (10-50px)
- ✅ Health check работает
- ✅ Валидация всех параметров
- ✅ Обработка ошибок

### Технические требования
- ✅ Node.js + Express + Sharp
- ✅ RESTful API
- ✅ Возвращает изображения в бинарном формате
- ✅ Content-Type корректный (image/png, image/jpeg, image/webp)
- ✅ Развернут на Vercel
- ✅ Работает без ошибок

### Документация
- ✅ README.md с описанием API
- ✅ Примеры запросов (curl)
- ✅ Описание всех параметров
- ✅ Описание ошибок

### Тестирование
- ✅ Все endpoints протестированы вручную
- ✅ Проверены edge cases
- ✅ Проверены ошибки валидации
- ✅ Проверены большие файлы

---

## Что НЕ входит в scope (Phase 1)

❌ Batch operations — несколько операций за 1 запрос
❌ Формат вывода (только PNG в MVP)
❌ Auto-focal — автоматическое определение центра

---

## Дедлайн

### Phase 1 (MVP)
- Разработка: 2026-02-22 — 2026-02-25 (4 дня)
- Тестирование: 2026-02-26 (1 день)
- Деплой: 2026-02-27 (1 день)
- **Всего:** 6 дней

### Phase 2 (опционально)
- Дополнительные фичи — после принятия MVP

---

## Стек технологий

```json
{
  "runtime": "Node.js",
  "version": "^18.0.0",
  "framework": "Express.js",
  "imageProcessing": "Sharp ^0.33.0",
  "deployment": "Vercel Serverless",
  "env": "Node.js 18.x"
}
```

---

**Дата создания:** 2026-02-21
**Статус:** ✅ Утверждено к разработке
